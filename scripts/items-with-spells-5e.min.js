class ItemsWithSpells5e{static MODULE_ID="items-with-spells-5e";static SETTINGS={};static FLAGS={itemSpells:"item-spells",parentItem:"parent-item",knownUuid:"original-uuid"};static TEMPLATES={spellsTabNew:`modules/${ItemsWithSpells5e.MODULE_ID}/templates/spells-tab-new.hbs`,spellsTab:`modules/${ItemsWithSpells5e.MODULE_ID}/templates/spells-tab.hbs`,overrides:`modules/${ItemsWithSpells5e.MODULE_ID}/templates/overrides-form.hbs`};static VERSIONS={get DnD5e_v4(){return foundry.utils.isNewerVersion(game.system.version,"4")}};static init(){ItemsWithSpells5e.preloadTemplates()}static preloadTemplates(){dnd5e.utils.registerHandlebarsHelpers(),loadTemplates(ItemsWithSpells5e.TEMPLATES)}static isIwsItem(e){"string"==typeof e&&(e=fromUuidSync(e));const t=e?.getFlag(ItemsWithSpells5e.MODULE_ID,ItemsWithSpells5e.FLAGS.itemSpells)??[];return t.length?t:null}static getSpellParentId(e){return"string"==typeof e&&(e=fromUuidSync(e)),e?.getFlag(ItemsWithSpells5e.MODULE_ID,ItemsWithSpells5e.FLAGS.parentItem)??null}static async getSpellParentItem(e,t=!1,s=!1){if("string"==typeof e&&(e=await fromUuid(e)),t&&!e?.isEmbedded)return null;const i=ItemsWithSpells5e.getSpellParentId(e);if(!i)return null;const l=s??e?.actor?.items??!1;if(t&&!l)return null;if(l){const e=i.split(".").pop();return l.get(e)??null}return await fromUuid(i)}static isIncludedItemType(e){let t=!1;try{t=!!game.settings.get(ItemsWithSpells5e.MODULE_ID,`isIncludedItemType${e.titleCase()}`)}catch{}return t}static isUsableItem(e){if("string"==typeof e&&(e=fromUuidSync(e)),!1===e?.system?.identified)return!1;if(game.settings.get(ItemsWithSpells5e.MODULE_ID,"excludeUnequipped")&&!1===e?.system.equipped)return!1;if(!game.user.isGM)if(foundry.utils.isNewerVersion(game.system.version,"3.1.99")){if("required"===e?.system?.attunement&&!e?.system?.attuned)return!1}else{const t=CONFIG.DND5E.attunementTypes?.REQUIRED??1;if(e?.system?.attunement===t)return!1}return!0}static async updateFlagsToV4(e){const t=ItemsWithSpells5e.isIwsItem(e),s=t?.some((e=>e.changes));if(s){const s=t.map((e=>(e.changes&&(e.overrides=ItemsWithSpells5e.updateChangesToV4(e.changes),delete e.changes),e)));await e.update({[`flags.${ItemsWithSpells5e.MODULE_ID}.${ItemsWithSpells5e.FLAGS.itemSpells}`]:s},{render:!1})}return e}static updateChangesToV4(e){e=foundry.utils.expandObject(e);const t={};if(e.system?.uses?.max&&(t["uses.max"]=e.system.uses.max),e.system?.uses?.per&&("charges"===e.system.uses.per&&(e.system.uses.per=""),t["uses.recovery"]=e.system.uses.per),e.system?.consume?.amount&&(t["consumption.value"]=e.system.consume.amount),e.system?.consume?.scale&&(t["consumption.scaling"]=e.system.consume.scale),e.system?.save?.scaling){switch(e.system.save.scaling){case"spell":e.system.save.scaling="spellcasting";break;case"flat":e.system.save.scaling=""}t["saveActivity.calculation"]=e.system.save.scaling}return e.system?.save?.dc&&(t["saveActivity.formula"]=e.system.save.dc),(e.system?.attack?.bonus||e.system?.attackBonus)&&(t["attackActivity.bonus"]=e.system?.attack?.bonus??e.system?.attackBonus,t["attackActivity.flat"]=!0),foundry.utils.expandObject(t)}static createUpdateObject(e,t,s={}){const i={[`flags.${ItemsWithSpells5e.MODULE_ID}.${ItemsWithSpells5e.FLAGS.parentItem}`]:e.id,"system.preparation.mode":"atwill","system.uses.spent":null},l=t.flags["tidy5e-sheet"]?.section;l&&(i["flags.tidy5e-sheet.section"]=null),s.uses?.max&&(i["system.uses.max"]=s.uses.max,s.uses.recovery?i["system.uses.recovery"]=[{period:s.uses.recovery}]:i["system.uses.recovery"]=null);const a=!!s.consumption?.value&&[{type:"itemUses",value:s.consumption.value,target:e.id,scaling:{mode:s.consumption.scaling?"amount":""}}];for(const e of t.system.activities.values()){const t=e.id;i[`system.activities.${t}.consumption.spellSlot`]=!1,a&&(i[`system.activities.${t}.consumption.targets`]=a),"save"===e.type&&s.saveActivity&&"noOverride"!==s.saveActivity?.calculation&&(i[`system.activities.${t}.save.dc.calculation`]=s.saveActivity.calculation,""===s.saveActivity.calculation&&s.saveActivity?.formula&&(i[`system.activities.${t}.save.dc.formula`]=s.saveActivity.formula)),"attack"===e.type&&s.attackActivity&&("noOverride"!==s.attackActivity.ability&&(i[`system.activities.${t}.attack.ability`]=s.attackActivity.ability),s.attackActivity.bonus&&(i[`system.activities.${t}.attack.bonus`]=s.attackActivity.bonus),s.attackActivity.flat&&(i[`system.activities.${t}.attack.flat`]=s.attackActivity.flat))}return i}}class ItemsWithSpells5eActorSheet{static init(){const e=ItemsWithSpells5e.MODULE_ID,t=ItemsWithSpells5eActorSheet.prepareItemSpellbook;["Character","NPC"].forEach((s=>{libWrapper.register(e,`dnd5e.applications.actor.ActorSheet5e${s}.prototype._prepareSpellbook`,t,"WRAPPER")}))}static prepareItemSpellbook(e,t,s){const i=game.settings.get(ItemsWithSpells5e.MODULE_ID,"sortOrder")?20:-5,l=[],a=new Map;s.forEach((e=>{const t=ItemsWithSpells5e.getSpellParentId(e);if(t&&this.actor.items.some((e=>[e.id,e.uuid].includes(t)))){const s=t.split(".").pop();a.get(s)||a.set(s,[]),a.get(s).push(e)}else l.push(e)}));const n=e(t,l);return this.actor.items.filter((e=>{if(!ItemsWithSpells5e.isIwsItem(e))return!1;return ItemsWithSpells5e.isIncludedItemType(e.type)})).forEach((e=>{const t=a.get(e.id);if(!t)return;if(!ItemsWithSpells5e.isUsableItem(e))return;const s=((e,t={},s=[])=>({order:i,label:e.name,usesSlots:!1,canCreate:!1,canPrepare:!1,spells:s,uses:t.value??"-",slots:t.max??"-",override:0,dataset:{"iws-item-id":e.id},prop:"item-"+e.id}))(e,e.system.uses,t);n.push(s)})),n.sort(((e,t)=>e.order-t.order||e.label-t.label)),n}}class ItemsWithSpells5eActor{static init(){Hooks.on("createItem",ItemsWithSpells5eActor.handleCreateItem),Hooks.on("deleteItem",ItemsWithSpells5eActor.handleDeleteItem)}static async handleDeleteItem(e,t,s){if(s!==game.user.id)return;if(!(e.parent instanceof Actor))return;if(["group","vehicle"].includes(e.parent.type))return;if(!ItemsWithSpells5e.isIwsItem(e))return;const i=e.actor.items.reduce(((t,s)=>{const i=ItemsWithSpells5e.getSpellParentId(s);return[e.id,e.uuid].includes(i)&&t.push(s.id),t}),[]);if(!i.length)return;const l=t.itemsWithSpells5e?.alsoDeleteChildSpells,a=!game.user.isGM&&!1===e.system?.identified;return!!(l??a)||await Dialog.confirm({title:game.i18n.localize("IWS.MODULE_NAME"),content:game.i18n.localize("IWS.DIALOG.AlsoDeleteSpell")})?e.actor.deleteEmbeddedDocuments("Item",i):void 0}static async handleCreateItem(e,t,s){if(s!==game.user.id)return;if(!(e.parent instanceof Actor))return;if(["group","vehicle"].includes(e.parent.type))return;if(!ItemsWithSpells5e.isIncludedItemType(e.type))return;e=await ItemsWithSpells5e.updateFlagsToV4(e);const i=ItemsWithSpells5e.isIwsItem(e);if(!i)return;const l=await Promise.all(i.map((t=>ItemsWithSpells5eActor._createSpellData(e,t)))),a=[],n=l.filter(((e,t)=>!!e&&a.push(i[t]?.overrides))),r=(await e.actor.createEmbeddedDocuments("Item",n)).map(((e,t)=>({uuid:e.uuid,id:e.id,overrides:a[t]})));return e.setFlag(ItemsWithSpells5e.MODULE_ID,ItemsWithSpells5e.FLAGS.itemSpells,r)}static async _createSpellData(e,t){const s=await fromUuid(t.uuid);if(!s)return null;const i=ItemsWithSpells5e.createUpdateObject(e,s,t.overrides),l=game.items.fromCompendium(s);return foundry.utils.mergeObject(l,i)}}const{ApplicationV2:e,HandlebarsApplicationMixin:t}=foundry.applications.api;class ItemsWithSpells5eItemSpellOverrides extends(t(e)){constructor(e,t){const s=e.itemSpellFlagMap.get(t),i=e.itemSpellItemMap.get(t);super({id:`${ItemsWithSpells5e.MODULE_ID}-${e.item.id}-${i.id}`}),this.overrides=s?.overrides??{},this.itemSpellId=t,this.itemWithSpellsItem=e,this.item=e.item,this.itemSpellItem=i}static DEFAULT_OPTIONS={id:ItemsWithSpells5e.MODULE_ID,tag:"form",form:{handler:ItemsWithSpells5eItemSpellOverrides._formHandler,closeOnSubmit:!1,submitOnChange:!0},position:{width:560,height:"auto"},window:{icon:"fas fa-wand-sparkles",title:"Override Dialog",contentClasses:["dnd5e2","sheet","item","iws"]}};static PARTS={form:{template:ItemsWithSpells5e.TEMPLATES.overrides},footer:{template:"templates/generic/form-footer.hbs"}};get title(){return`${this.item.name} - ${this.itemSpellItem.name}`}_prepareContext(){const e=this.itemSpellItem,t=e.system.activities.getByType("save"),s=e.system.activities.getByType("attack"),i=s[0]??t[0]??e.isActive?e.system.activities.entries().next().value[1]:{},l=this.overrides,a=`${game.i18n.localize("Save")} & ${game.i18n.localize("Close")}`,n=this.item.hasLimitedUses&&this.item.system?.uses?.max>0,r=Object.entries(CONFIG.DND5E.abilities).map((([e,t])=>({value:e,label:t.label,group:game.i18n.localize("DND5E.Abilities")})));return{spell:e,overrides:l,spellStats:{activity:i,saveActivity:t[0]??{},attackActivity:s[0]??{},spentUses:e.isEmbedded?e.system.uses.spent:"",hasNoFlatDC:l.activities?.Saves?.save?.dc?.calculation??"",saveAbility:t[0]?.save?.ability},options:{recoveryPeriods:[{value:"",label:"DND5E.UsesPeriods.Never"},...Object.entries(CONFIG.DND5E.limitedUsePeriods).filter((([,e])=>!e.deprecated)).map((([e,t])=>({value:e,label:t.label,group:game.i18n.localize("DND5E.DurationTime")})))],abilityOptions:[{value:"noOverride",label:game.i18n.localize("IWS.FORM.NoOverride")},{rule:!0},{value:"",label:game.i18n.format("DND5E.DefaultSpecific",{default:game.i18n.localize("DND5E.Spellcasting").toLowerCase()})},{value:"none",label:game.i18n.localize("DND5E.None")},{value:"spellcasting",label:game.i18n.localize("DND5E.SpellAbility")},...r],calculationOptions:[{value:"noOverride",label:game.i18n.localize("IWS.FORM.NoOverride")},{rule:!0},{value:"",label:`${game.i18n.localize("DND5E.Flat")} (${game.i18n.localize("DND5E.SAVE.FIELDS.save.dc.CustomFormula")})`},{value:"spellcasting",label:game.i18n.localize("DND5E.SpellAbility")},...r],itemUses:[{value:"itemUses",label:"DND5E.CONSUMPTION.Type.ItemUses.Label"}],parentItem:[{value:this.item.id,label:this.item.name}]},parentItem:{id:this.item.id,name:this.item.name,isEmbedded:this.item.isEmbedded,hasNoUses:!n,hasNoUsesHint:!n&&"IWS.FORM.NoUsesHint"},buttons:[{type:"submit",icon:"fa-solid fa-save",label:a}],fieldDefault:new foundry.data.fields.StringField,inputs:{createCheckboxInput:dnd5e.applications.fields.createCheckboxInput}}}static async _formHandler(e,t,s){const i=foundry.utils.expandObject(s.object);if(this.overrides=i.overrides,e instanceof SubmitEvent)await this.itemWithSpellsItem.updateItemSpellOverrides(this.itemSpellId,this.overrides),this.close();else{const e=this.element.querySelector(":focus"),t=e?`${e.tagName}[name="${e.name}"]`:null;this.render(null,{focusSelector:t})}}_onRender(e,t){super._onRender(e,t),this.element.querySelectorAll(".label-top > p.hint").forEach((e=>{const t=e.parentElement.querySelector(":scope > label");t&&(e.ariaLabel=e.innerText,e.dataset.tooltip=e.innerHTML,e.innerHTML="",t.insertAdjacentElement("beforeend",e))})),t.focusSelector&&this.element.querySelector(t.focusSelector)?.focus()}}class ItemsWithSpells5eItem{constructor(e){this.item=e,this._itemSpellFlagMap=null,this._itemSpellItems=null}get itemSpellFlagMap(){return null===this._itemSpellFlagMap?this._getItemSpellFlagMap():this._itemSpellFlagMap}get itemSpellList(){return this.item.getFlag(ItemsWithSpells5e.MODULE_ID,ItemsWithSpells5e.FLAGS.itemSpells)??[]}get itemSpellItemMap(){return null===this._itemSpellItems?this._getItemSpellItems():this._itemSpellItems}async refresh(){this._getItemSpellFlagMap(),await this._getItemSpellItems()}async _getChildItem({uuid:e,overrides:t={}}){let s=await fromUuid(e);if([this.item.id,this.item.uuid].includes(ItemsWithSpells5e.getSpellParentId(s)))return s;s||(s=((e,t)=>new Item.implementation({name:game.i18n.localize("IWS.MISSING_ITEM.Name"),img:"icons/svg/hazard.svg",type:"spell",system:{description:{value:game.i18n.localize("IWS.MISSING_ITEM.Description")}},_id:e.split(".").pop()},{temporary:!0,parent:t}))(e,this.item.parent));const i=ItemsWithSpells5e.createUpdateObject(this.item,s,t);i[`flags.${ItemsWithSpells5e.MODULE_ID}.${ItemsWithSpells5e.FLAGS.knownUuid}`]=e;const l=new Item.implementation(s.toObject(),{temporary:!0,keepId:!1,parent:this.item.parent});return await l.updateSource(i),l}async _getItemSpellItems(){const e=new Map;return await Promise.all(this.itemSpellList.map((async({uuid:t,overrides:s})=>{const i=await this._getChildItem({uuid:t,overrides:s});if(i)return e.set(i.id,i),i}))),this._itemSpellItems=e,e}_getItemSpellFlagMap(){const e=new Map;return this.itemSpellList.forEach((t=>{const s=t.uuid.split(".").pop();e.set(s,t)})),this._itemSpellFlagMap=e,e}async addSpellToItem(e){let t=e;if(this.item.isEmbedded){const e=await fromUuid(t);if(!e)return void ui.notifications.error("Item data for",t,"not found");const s=ItemsWithSpells5e.createUpdateObject(this.item,e),i=foundry.utils.mergeObject(e.toObject(),s),[l]=await this.item.actor.createEmbeddedDocuments("Item",[i]);t=l.uuid}const s=[...this.itemSpellList,{uuid:t}],i=`flags.${ItemsWithSpells5e.MODULE_ID}.${ItemsWithSpells5e.FLAGS.itemSpells}`;await this.item.update({[i]:s},{render:!1}),await this.refresh(),this.item.render(),this.item.actor&&this.item.actor.render()}async removeSpellFromItem(e,{alsoDeleteEmbeddedSpell:t}={}){const s=this.itemSpellItemMap.get(e);!this.item.isEmbedded&&s.sheet.rendered&&s.sheet.close();const i=this.item.isEmbedded?s.uuid:s.getFlag(ItemsWithSpells5e.MODULE_ID,ItemsWithSpells5e.FLAGS.knownUuid),l=this.itemSpellList.filter((({uuid:e})=>e!==i));if(this._itemSpellItems?.delete(e),this._itemSpellFlagMap?.delete(e),await this.item.setFlag(ItemsWithSpells5e.MODULE_ID,ItemsWithSpells5e.FLAGS.itemSpells,l),!this.item.isEmbedded)return;const a=fromUuidSync(i);if(!a)return;return t&&await Dialog.confirm({title:game.i18n.localize("IWS.MODULE_NAME"),content:game.i18n.localize("IWS.DIALOG.DeleteOrphanedSpells")})?a.delete():a.unsetFlag(ItemsWithSpells5e.MODULE_ID,ItemsWithSpells5e.FLAGS.parentItem)}async updateItemSpellOverrides(e,t){const s=this.itemSpellFlagMap.get(e);s.overrides=t,this.itemSpellFlagMap.set(e,s);const i=[...this.itemSpellFlagMap.values()];await this.item.update({[`flags.${ItemsWithSpells5e.MODULE_ID}.${ItemsWithSpells5e.FLAGS.itemSpells}`]:i},{render:!1}),await this.refresh(),this.item.render()}static async getItemSpells(e,t=!1,s=!1){if("string"==typeof e&&(e=await fromUuid(e)),t&&!e.isEmbedded)return null;const i=new ItemsWithSpells5eItem(e);if(!i.itemSpellList.length)return null;const l=!!(s??t)&&e.actor?.items;if(t&&!l)return null;if(l){const t=new Map,s=[e.id??e._id,e.uuid];return l.forEach((e=>{const i=ItemsWithSpells5e.getSpellParentId(e);s.includes(i)&&t.set(e.id,e)})),t}return await i.itemSpellItemMap}}class ItemsWithSpells5eItemSheet{constructor(e,[t]){this.app=e,this.item=e.item,this.sheetHtml=t,this.itemWithSpellsItem=new ItemsWithSpells5eItem(this.item)}static instances=new Map;static init(){Hooks.on("renderItemSheetV2",((e,t)=>{if(game.modules.get("tidy5e-sheet")?.api?.isTidy5eItemSheet(e)||!ItemsWithSpells5e.isIncludedItemType(e.item.type))return;let s=ItemsWithSpells5eItemSheet.instances.get(e.appId);return s||(s=new ItemsWithSpells5eItemSheet(e,t),ItemsWithSpells5eItemSheet.instances.set(e.appId,s)),s.renderLite()})),Hooks.on("closeItemSheet",(async e=>{const t=ItemsWithSpells5eItemSheet.instances.get(e.appId);if(t)return await t._unlinkSpellSheets(),ItemsWithSpells5eItemSheet.instances.delete(e.appId)})),Hooks.once("tidy5e-sheet.ready",(e=>{const t=new e.models.HtmlTab({title:game.i18n.localize("TYPES.Item.spellPl"),tabId:ItemsWithSpells5e.MODULE_ID,html:"",enabled:e=>ItemsWithSpells5e.isIncludedItemType(e.item.type),onRender(e){if(!ItemsWithSpells5e.isIncludedItemType(e.data.item.type))return;let t=e.app,s=[e.element],i=ItemsWithSpells5eItemSheet.instances.get(t.appId);return i||(i=new ItemsWithSpells5eItemSheet(t,s),ItemsWithSpells5eItemSheet.instances.set(t.appId,i)),i.renderHeavy(e.tabContentsElement,!1)}});e.registerItemTab(t,{autoHeight:!0})})),dnd5e.applications.item.ItemSheet5e2.TABS.push({tab:ItemsWithSpells5e.MODULE_ID,label:"TYPES.Item.spellPl",condition:ItemsWithSpells5eItemSheet._displayTab.bind(this)})}static _displayTab(e){return ItemsWithSpells5e.isIncludedItemType(e.type)&&(game.user.isGM||!1!==e.system.identified)}async _renderSpellsList(e){await ItemsWithSpells5e.updateFlagsToV4(this.item),await this.itemWithSpellsItem.refresh();const t=[...(await this.itemWithSpellsItem.itemSpellItemMap).values()].map((e=>{if(e.hasSave&&(e.activitySave=e.system.activities.getByType("save")[0],e.displaySave=!(!e.activitySave.labels.save||!e.isEmbedded&&""!==e.activitySave.save.dc.calculation)),e.hasAttack&&(e.activityAttack=e.system.activities.getByType("attack")[0],e.displayAttack=!(!e.activityAttack.labels.toHit||!e.isEmbedded&&!e.activityAttack.attack.flat)),e.isActive){let t=e.system.activities.filter((e=>e.consumption.targets.some((e=>e.target===this.item.id))));t.length&&(e.parentConsumption=t[0].consumption.targets.filter((e=>e.target===this.item.id))[0])}return e})),s=e?ItemsWithSpells5e.TEMPLATES.spellsTabNew:ItemsWithSpells5e.TEMPLATES.spellsTab,i=game.i18n.localize("DND5E.Spellcasting"),l={spellcasting:i,none:game.i18n.format("IWS.TAB.AbilityBased",{ability:game.i18n.localize("DND5E.None")})};for(let e in CONFIG.DND5E.abilities)l[e]=game.i18n.format("IWS.TAB.AbilityBased",{ability:CONFIG.DND5E.abilities[e].abbreviation});const a={itemSpells:t,config:{limitedUsePeriods:CONFIG.DND5E.limitedUsePeriods,abilities:CONFIG.DND5E.abilities,saveCalcOptions:{"":game.i18n.localize("DND5E.Flat"),...l},attackCalcOptions:{"":i,...l}},isEmbedded:this.item.isEmbedded,isOwner:this.item.isOwner,concealDetails:!game.user.isGM&&!1===this.item.system.identified};return await this._linkSpellSheets(),renderTemplate(s,a)}async _dragEnd(e){if(!this.app.isEditable)return;const t=TextEditor.getDragEventData(e);if("Item"!==t.type)return;return"spell"===(await fromUuid(t.uuid)).type?this.itemWithSpellsItem.addSpellToItem(t.uuid):void 0}async _handleItemClick(e){const t=e.currentTarget.closest("[data-item-id]").dataset.itemId,s=this.itemWithSpellsItem.itemSpellItemMap.get(t);this.item.isEmbedded?fromUuidSync(s.uuid).use({event:e,legacy:!1}):s?.sheet.render(!0,{editable:!1})}async _handleItemEditClick(e){const t=e.currentTarget.closest("[data-item-id]").dataset.itemId,s=this.itemWithSpellsItem.itemSpellItemMap.get(t);let i=s;if(!s.isEmbedded){const e=s.getFlag(ItemsWithSpells5e.MODULE_ID,ItemsWithSpells5e.FLAGS.knownUuid);i=await fromUuid(e)}i?.sheet.render(!0)}async _handleItemDeleteClick(e){const t=e.currentTarget.closest("[data-item-id]").dataset.itemId;return this.itemWithSpellsItem.removeSpellFromItem(t)}async _handleItemDestroyClick(e){const t=e.currentTarget.closest("[data-item-id]").dataset.itemId;return this.itemWithSpellsItem.removeSpellFromItem(t,{alsoDeleteEmbeddedSpell:!0})}async _handleOverridesConfigureClick(e){const t=e.currentTarget.closest("[data-item-id]").dataset.itemId,s=this.itemWithSpellsItem.itemSpellItemMap.get(t);return this.item.isEmbedded?fromUuidSync(s.uuid).sheet.render(!0):(s.sheet.rendered&&s.sheet.close(),new ItemsWithSpells5eItemSpellOverrides(this.itemWithSpellsItem,t).render(!0))}renderLite(){const e=document.createElement("DIV"),t=this.app._tabs?.[0]?.active===ItemsWithSpells5e.MODULE_ID?"active":"",s=this.sheetHtml.querySelector(".sheet-body");e.innerHTML=`<div class="tab ${ItemsWithSpells5e.MODULE_ID} ${t}" data-group="primary" data-tab="${ItemsWithSpells5e.MODULE_ID}"></div>`;const i=e.firstElementChild;s.appendChild(i);const l=ItemsWithSpells5e.VERSIONS.DnD5e_v4;this.renderHeavy(i,l)}async renderHeavy(e,t){const s=document.createElement("DIV");s.innerHTML=await this._renderSpellsList(t);const i=s.firstElementChild;e.appendChild(i),i.querySelectorAll(".item-name").forEach((e=>e.addEventListener("click",this._handleItemClick.bind(this)))),i.querySelectorAll(".configure-overrides").forEach((e=>e.addEventListener("click",this._handleOverridesConfigureClick.bind(this)))),i.querySelectorAll(".item-edit").forEach((e=>e.addEventListener("click",this._handleItemEditClick.bind(this)))),i.querySelectorAll(".item-destroy").forEach((e=>e.addEventListener("click",this._handleItemDestroyClick.bind(this)))),i.querySelectorAll(".item-delete").forEach((e=>e.addEventListener("click",this._handleItemDeleteClick.bind(this))));const l={dragSelector:".item",dropSelector:`.${ItemsWithSpells5e.MODULE_ID}`,permissions:{drop:()=>this.app.isEditable&&!this.item.isEmbedded},callbacks:{drop:this._dragEnd}};e.addEventListener("drop",l.callbacks.drop.bind(this))}async _linkSpellSheets(){return Promise.all(this.itemWithSpellsItem.itemSpellList.map((async({uuid:e,overrides:t})=>{const s=await fromUuid(e);return s&&(s.apps[this.app.appId]=this.app),s})))}async _unlinkSpellSheets(){return Promise.all(this.itemWithSpellsItem.itemSpellList.map((async({uuid:e,overrides:t})=>{const s=await fromUuid(e);return s?.apps[this.app.appId]&&delete s.apps[this.app.appId],s})))}}const s=["class","subclass","background","race","lineage","spell","base","container","backpack"];class IWS_TypeSettings extends FormApplication{get id(){return`${ItemsWithSpells5e.MODULE_ID}-item-type-exclusion-menu`}get title(){return game.i18n.localize("IWS.SETTINGS.ITEM_EXCLUSION.TITLE")}get template(){return"modules/items-with-spells-5e/templates/settingsMenu.hbs"}async getData(){const e=Item.TYPES.filter((e=>!s.includes(e))),t=await super.getData();t.types=[];for(const s of e)t.types.push({checked:game.settings.get(ItemsWithSpells5e.MODULE_ID,`isIncludedItemType${label}`),value:s,label:game.i18n.localize(`TYPES.Item.${s}`)});return t.sort(((e,t)=>e.label>t.label?1:e.label<t.label?-1:0))}async _updateObject(e,t){Object.entries(t).forEach((([e,t])=>{game.settings.set(ItemsWithSpells5e.MODULE_ID,`isIncludedItemType${e.titleCase()}`,t)}))}}let i=null;class ItemsWithSpells5eExtendHUD{static init(){game.modules.get("token-action-hud-core")?.active&&game.modules.get("token-action-hud-dnd5e")?.active&&foundry.utils.isNewerVersion(game.modules.get("token-action-hud-dnd5e")?.version,"1.5.6")&&(Hooks.once("tokenActionHudCoreRegisterDefaults",(async e=>{const t="Items with Spells",s=e.layout.find((e=>"spells"===e.id)),i={id:ItemsWithSpells5e.MODULE_ID,name:t,listName:`Group: ${t}`,type:"system",nestId:`spells_${ItemsWithSpells5e.MODULE_ID}`};e.groups.push(i),s.groups.unshift(i)})),Hooks.once("tokenActionHudCoreApiReady",(async e=>{i=class ItemsWithSpellsActionHandlerExtender extends e.api.ActionHandlerExtender{constructor(e){super(),this.actionHandler=e,this.actor=null,this.iwsExcludeUnequipped=null}async extendActionHandler(){if(this.actor=this.actionHandler.actor,!this.actor)return;this.iwsExcludeUnequipped=game.settings.get(ItemsWithSpells5e.MODULE_ID,"excludeUnequipped");const e={id:ItemsWithSpells5e.MODULE_ID,type:"system"};for(const[t,i]of this.actor.items.entries()){if(s.includes(i.type))continue;if(!ItemsWithSpells5e.isUsableItem(i))continue;const t=await ItemsWithSpells5eItem.getItemSpells(i,!0,this.actor.items);if(!t)continue;const l={},a=i?.system?.uses;if(a?.max>0){const e="charges"===a.recovery[0]?.period?"":` ${game.i18n.localize("DND5E.per")} `,t=CONFIG.DND5E.limitedUsePeriods[a.recovery[0]?.period]?.label??a.recovery[0]?.period,s=t?`${e}${t}`:"",i=a.max-(a.spent??0);l.text=`${i}/${a.max}`,l.title=`${text}${s}`}const n={id:`${ItemsWithSpells5e.MODULE_ID}_${i.id}`,name:i.name,type:"system-derived",info1:l,defaultSelected:!0,settings:{sort:!0}};this.actionHandler.addGroup(n,e);const r={groupData:n,actionData:t,actionType:"spell"};await this.actionHandler.buildActions(r)}}}})),Hooks.once("tokenActionHudCoreAddActionHandlerExtenders",(async e=>{e.addActionHandlerExtender(new i(e))})))}}Hooks.once("setup",(function _registerSettings(){const e=Item.TYPES.filter((e=>!s.includes(e)));for(const t of e)game.settings.register(ItemsWithSpells5e.MODULE_ID,`isIncludedItemType${t.titleCase()}`,{scope:"world",config:!1,type:Boolean,default:!0,requiresReload:!0});game.settings.register(ItemsWithSpells5e.MODULE_ID,"sortOrder",{name:"IWS.SETTINGS.SORT_ORDER.NAME",hint:"IWS.SETTINGS.SORT_ORDER.HINT",scope:"world",config:!0,type:Boolean,default:!1,requiresReload:!1}),game.settings.registerMenu(ItemsWithSpells5e.MODULE_ID,"itemTypeExclusion",{name:"IWS.SETTINGS.ITEM_EXCLUSION.NAME",hint:"IWS.SETTINGS.ITEM_EXCLUSION.HINT",scope:"world",config:!0,type:IWS_TypeSettings,label:"IWS.SETTINGS.ITEM_EXCLUSION.NAME",restricted:!0}),game.settings.register(ItemsWithSpells5e.MODULE_ID,"excludeUnequipped",{name:"IWS.SETTINGS.EXCLUDE_UNEQUIPPED.NAME",hint:"IWS.SETTINGS.EXCLUDE_UNEQUIPPED.HINT",scope:"world",config:!0,type:Boolean,default:!0,requiresReload:!1})})),Hooks.once("init",ItemsWithSpells5eActor.init),Hooks.once("init",ItemsWithSpells5eActorSheet.init),Hooks.once("init",ItemsWithSpells5e.init),Hooks.once("init",ItemsWithSpells5eItemSheet.init),Hooks.once("init",ItemsWithSpells5eExtendHUD.init),Hooks.once("ready",(async()=>{game.modules.get(ItemsWithSpells5e.MODULE_ID).api={isIwsItem:ItemsWithSpells5e.isIwsItem,isIwsSpell:ItemsWithSpells5e.getSpellParentId,getItemSpells:ItemsWithSpells5eItem.getItemSpells,getSpellParentId:ItemsWithSpells5e.getSpellParentId,getSpellParentItem:ItemsWithSpells5e.getSpellParentItem,isIncludedItemType:ItemsWithSpells5e.isIncludedItemType,isUsableItem:ItemsWithSpells5e.isUsableItem,updateFlagsToV4:ItemsWithSpells5e.updateFlagsToV4,updateChangesToV4:ItemsWithSpells5e.updateChangesToV4}}));export{ItemsWithSpells5e,ItemsWithSpells5eActor,ItemsWithSpells5eActorSheet,ItemsWithSpells5eExtendHUD,ItemsWithSpells5eItem,ItemsWithSpells5eItemSheet,ItemsWithSpells5eItemSpellOverrides};
//# sourceMappingURL=items-with-spells-5e.min.js.map
